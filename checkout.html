<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Nile Online Market</title>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <style>
        body { font-family: Arial, Helvetica, sans-serif; background-color: #f5f5f5; color: #333; margin: 0; padding: 0; }
        header { background-color: #131921; display: flex; justify-content: space-between; align-items: center; padding: 10px 40px; }
        .logo img { height: 50px; }
        .cart { color: #fff; font-weight: 600; }
        .checkout-page { max-width: 1000px; margin: 60px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; }
        .btn { padding: 12px 30px; background-color: #febd69; color: #131921; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; text-transform: uppercase; margin: 10px; }
        .btn:hover { background-color: #f3a847; }
        input { padding: 10px; width: 300px; margin-bottom: 20px; }
    </style>
</head>
<body onload="updateCartCount()">

    <header>
        <div class="logo"><img src="logo.png" alt="Nile Online Market Logo"></div>
        <div class="cart">Cart ðŸ›’ (<span id="cart-count">0</span>)</div>
    </header>

    <div class="checkout-page">
        <h1>Checkout</h1>
        <p>Enter your email to receive order confirmation:</p>
        <input type="email" id="customer-email" placeholder="Your Email"><br>
        <button class="btn" onclick="payNow()">Pay with Card</button>
        <button class="btn" onclick="payNow()">Pay with PayPal</button>
        <button class="btn" onclick="payNow()">Pay with Mobile Money</button>
    </div>

    <script>
        // Initialize EmailJS with your public key
        (function() {
            emailjs.init("048OB1q9jJCO0w5V0");
        })();

        function updateCartCount() {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            document.getElementById('cart-count').textContent = cart.length;
        }

        function payNow() {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart.length === 0) {
                alert("Cart is empty!");
                return;
            }

            let customerEmail = document.getElementById('customer-email').value.trim();
            if (!customerEmail) {
                alert("Please enter your email to continue.");
                return;
            }

            let orderNumber = 'NILE' + Date.now();
            let total = 0;
            let ordersArray = cart.map(item => {
                total += item.price;
                return {
                    name: item.name,
                    units: 1,
                    price: item.price,
                    image_url: item.image || "https://via.placeholder.com/150"
                };
            });

            let params = {
                order_id: orderNumber,
                orders: ordersArray,
                cost: {
                    shipping: "10.00",
                    tax: "0.00",
                    total: (total + 10).toFixed(2)
                },
                email: customerEmail, // Customer email inside template variables
                to_email: `eshetuwek1@gmail.com, ${customerEmail}` // Always admin + customer together
            };

            emailjs.send("service_i2ud88k", "template_9cd4w2a", params)
                .then(function(response) {
                    alert(`Payment Successful.\nOrder #${orderNumber} has been sent to your email and admin.`);
                    localStorage.removeItem('cart');
                    window.location.href = 'index.html';
                }, function(error) {
                    console.error("EmailJS Error:", error);
                    alert("Failed to send order. Check console for details.");
                });
        }
    </script>

</body>
</html>
